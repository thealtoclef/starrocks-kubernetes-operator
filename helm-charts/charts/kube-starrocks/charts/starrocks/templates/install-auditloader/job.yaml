{{- if and .Values.installAuditLoader.enabled .Values.installAuditLoader.isInstall .Release.IsInstall }}
apiVersion: batch/v1
kind: Job
metadata:
  name: {{ template "starrockscluster.name" . }}-audit-loader
  namespace: {{ template "starrockscluster.namespace" . }}
  labels:
    cluster: {{ template "starrockscluster.name" . }}
  {{- if .Values.installAuditLoader.annotations }}
  annotations:
    {{- toYaml .Values.installAuditLoader.annotations | nindent 4 }}
  {{- end }}
spec:
  template:
    spec:
      {{- if or .Values.starrocksFESpec.imagePullSecrets .Values.starrocksCluster.componentValues.imagePullSecrets }}
      imagePullSecrets:
        {{- include "starrockscluster.fe.imagePullSecrets" . | nindent 6 }}
      {{- end }}
      {{- if or .Values.starrocksFESpec.affinity .Values.starrocksCluster.componentValues.affinity }}
      affinity:
        {{- include "starrockscluster.fe.affinity" . | nindent 8 }}
      {{- end }}
      {{- if or .Values.starrocksFESpec.tolerations .Values.starrocksCluster.componentValues.tolerations }}
      tolerations:
        {{- include "starrockscluster.fe.tolerations" . | nindent 8 }}
      {{- end }}
      containers:
      - name: {{ template "starrockscluster.name" . }}-audit-loader
        {{- if .Values.installAuditLoader.image }}
        image: {{ .Values.installAuditLoader.image }}
        {{- else }}
        image: {{ .Values.starrocksFESpec.image.repository }}:{{ include "starrockscluster.fe.image.tag" . }}
        {{- end }}
        imagePullPolicy: IfNotPresent
        {{- if .Values.installAuditLoader.resources }}
        resources: {{- toYaml .Values.installAuditLoader.resources | nindent 10 }}
        {{- end }}
        command:
        - /bin/bash
        args:
        - /opt/starrocks/install_auditloader.sh
        - {{ template "starrockscluster.name" . }}-fe-0.{{ template "starrockscluster.name" . }}-fe-search
        - "{{- default 9030 (include "starrockscluster.fe.query.port" .) }}"
        env:
          - name: "PLUGINS_DIR"
            value: {{ .Values.installAuditLoader.pluginsDir }}
          {{- if and .Values.initPassword.enabled (.Values.starrocksFESpec.feEnvVars | toJson | contains "MYSQL_PWD" | not) }}
          - name: "MYSQL_PWD"
            valueFrom:
              secretKeyRef:
                name: {{ template "starrockscluster.initpassword.secret.name" . }}
                key: password
          {{- end }}
        volumeMounts:
        - mountPath: /opt/starrocks/install_auditloader.sh
          name: {{ template "starrockscluster.name" . }}-install-auditloader-shell
          subPath: install_auditloader.sh
      volumes:
      - configMap:
          defaultMode: 420
          items:
            - key: install_auditloader.sh
              path: install_auditloader.sh
          name: {{ template "starrockscluster.name" . }}-install-auditloader-shell
          optional: false
        name: {{ template "starrockscluster.name" . }}-install-auditloader-shell
      restartPolicy: OnFailure
  backoffLimit: 10
{{- end }}
